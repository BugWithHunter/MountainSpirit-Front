<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bughunters.mountainspirit.memberrank.query.mapper.MemberRankQueryRepository">
    <resultMap id="findHigherClimbers" type="com.bughunters.mountainspirit.memberrank.query.dto.HigherClimber">
        <result property="cumId" column="cumId"/>
        <result property="frtrlId" column="frtrlId"/>
        <result property="mtRankId" column="mtRankId"/>
        <result property="climbCount" column="climbCount"/>
    </resultMap>

    <select id="selectHigherClimberByMountain" parameterType="string" resultMap="findHigherClimbers">
        SELECT
               b.cumId
             , b.mtRankId
             , a.frtrlId
             , count(*) as climbCount
          FROM ClimbRecord a
          JOIN MountainRank b
            ON a.frtrlId = b.frtrlId
           AND a.cumId = b.cumId
         WHERE b.mtRankId >= 2
           AND b.frtrlId = #{frtrlId}
         GROUP BY b.cumId , b.mtRankId
         ORDER BY climbCount DESC, b.mtRankId DESC
         LIMIT 2;
    </select>
</mapper>